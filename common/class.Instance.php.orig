<?php 
class Instance {
<<<<<<< HEAD:common/class.Instance.php
	var $id;
	var $twitter_username;
	var $twitter_user_id;
	var $last_status_id;
	var $last_page_fetched_followers;
	var $last_page_fetched_friends;
	var $last_page_fetched_replies;
	var $last_page_fetched_tweets;
	var $total_tweets_in_system;
	var $total_replies_in_system;
	var $total_follows_in_system;
	var $total_friends_in_system;
	var $total_users_in_system;
	var $is_archive_loaded_replies;
	var $is_archive_loaded_follows;
	var $is_archive_loaded_friends;
	var $crawler_last_run;
	var $earliest_reply_in_system;
	var $api_calls_to_leave_unmade_per_minute;
	var $avg_replies_per_day;
	var $is_public = false;

	function Instance($r) {
		$this->id = $r["id"];
		$this->twitter_username = $r['twitter_username'];
		$this->twitter_user_id = $r['twitter_user_id'];
		$this->last_status_id=$r['last_status_id'];
		$this->last_page_fetched_followers=$r['last_page_fetched_followers'];
		$this->last_page_fetched_replies=$r['last_page_fetched_replies'];
		$this->last_page_fetched_tweets=$r['last_page_fetched_tweets'];
		$this->total_tweets_in_system=$r['total_tweets_in_system'];
		$this->total_replies_in_system=$r['total_replies_in_system'];
		$this->total_follows_in_system=$r['total_follows_in_system'];
		$this->total_users_in_system=$r['total_users_in_system'];
		if ( $r['is_archive_loaded_replies'] == 1)
			$this->is_archive_loaded_replies = true;
		else
			$this->is_archive_loaded_replies = false;

		if ( $r['is_archive_loaded_follows'] == 1)
			$this->is_archive_loaded_follows = true;
		else
			$this->is_archive_loaded_follows = false;

		$this->crawler_last_run=$r['crawler_last_run'];
		$this->earliest_reply_in_system=$r['earliest_reply_in_system'];
		$this->api_calls_to_leave_unmade_per_minute=$r['api_calls_to_leave_unmade_per_minute'];
		$this->avg_replies_per_day = $r['avg_replies_per_day'];
		if ($r['is_public'] == 1)
			$this-> is_public = true;
	}
=======
    var $id;
    var $twitter_username;
    var $twitter_user_id;
    var $last_status_id;
    var $last_page_fetched_followers;
    var $last_page_fetched_friends;
    var $last_page_fetched_replies;
    var $last_page_fetched_tweets;
    var $total_tweets_in_system;
    var $total_replies_in_system;
    var $total_follows_in_system;
    var $total_friends_in_system;
    var $total_users_in_system;
    var $is_archive_loaded_replies;
    var $is_archive_loaded_follows;
    var $is_archive_loaded_friends;
    var $crawler_last_run;
    var $earliest_reply_in_system;
    var $api_calls_to_leave_unmade_per_minute;
    var $avg_replies_per_day;
    var $is_public = false;
    
    function Instance($r) {
        $this->id = $r["id"];
        $this->twitter_username = $r['twitter_username'];
        $this->twitter_user_id = $r['twitter_user_id'];
        $this->last_status_id = $r['last_status_id'];
        $this->last_page_fetched_followers = $r['last_page_fetched_followers'];
        $this->last_page_fetched_replies = $r['last_page_fetched_replies'];
        $this->last_page_fetched_tweets = $r['last_page_fetched_tweets'];
        $this->total_tweets_in_system = $r['total_tweets_in_system'];
        $this->total_replies_in_system = $r['total_replies_in_system'];
        $this->total_follows_in_system = $r['total_follows_in_system'];
        $this->total_users_in_system = $r['total_users_in_system'];
        if ($r['is_archive_loaded_replies'] == 1)
            $this->is_archive_loaded_replies = true;
        else
            $this->is_archive_loaded_replies = false;
            
        if ($r['is_archive_loaded_follows'] == 1)
            $this->is_archive_loaded_follows = true;
        else
            $this->is_archive_loaded_follows = false;
>>>>>>> 76ef61b3f270b23a3c051a40de2ca94f8be3968e:common/class.Instance.php

            
        $this->crawler_last_run = $r['crawler_last_run'];
        $this->earliest_reply_in_system = $r['earliest_reply_in_system'];
        $this->api_calls_to_leave_unmade_per_minute = $r['api_calls_to_leave_unmade_per_minute'];
        $this->avg_replies_per_day = $r['avg_replies_per_day'];
        if ($r['is_public'] == 1)
            $this->is_public = true;
            
    }
    
}

<<<<<<< HEAD:common/class.Instance.php
class InstanceDAO {
	$cfg = new Config();

	function getInstanceStalestOne() {
		return $this->getInstanceOneByLastRun("ASC");
	}

	function getInstanceFreshestOne() {
		return $this->getInstanceOneByLastRun("DESC");
	}

	function insert($id, $user) {
		$q = "
			INSERT INTO
				" . $this->cfg->table_prefix . "instances (`twitter_user_id`, `twitter_username`)
			VALUES
=======
class InstanceDAO extends MySQLDAO {
	function InstanceDAO($database, $logger=null) {
		parent::MySQLDAO($database, $logger);
	}
	
    function getInstanceStalestOne() {
        return $this->getInstanceOneByLastRun("ASC");
    }
    
    function getInstanceFreshestOne() {
        return $this->getInstanceOneByLastRun("DESC");
    }
    
    function insert($id, $user) {
        $q = "
			INSERT INTO 
				%prefix%instances (`twitter_user_id`, `twitter_username`)
			 VALUES
>>>>>>> 76ef61b3f270b23a3c051a40de2ca94f8be3968e:common/class.Instance.php
				(".$id." , '".$user."')";
        $sql_result = $this->executeSQL($q);
    }

<<<<<<< HEAD:common/class.Instance.php
	private function getAverageReplyCount() {
		return "round(total_replies_in_system/(datediff(curdate(), earliest_reply_in_system)), 2) as avg_replies_per_day";
	}

	function getFreshestByOwnerId($owner_id) {
		$q = "
			SELECT
				* , ". $this->getAverageReplyCount() ."
			FROM
				" . $this->cfg->table_prefix . "instances i
			INNER JOIN
				" . $this->cfg->table_prefix . "owner_instances oi
			ON
=======
    
    private function getAverageReplyCount() {
        return "round(total_replies_in_system/(datediff(curdate(), earliest_reply_in_system)), 2) as avg_replies_per_day";
    }

    
    function getFreshestByOwnerId($owner_id) {
        $q = "
			SELECT 
				* , ".$this->getAverageReplyCount()."
			FROM 
				%prefix%instances i
			INNER JOIN
				%prefix%owner_instances oi
			ON 
>>>>>>> 76ef61b3f270b23a3c051a40de2ca94f8be3968e:common/class.Instance.php
				i.id = oi.instance_id
			WHERE
				oi.owner_id = ".$owner_id."
			ORDER BY
				crawler_last_run DESC";
<<<<<<< HEAD:common/class.Instance.php

		$sql_result = Database::exec($q);
		if (mysql_num_rows  ( $sql_result  ) == 0 ) {
			$i = null;
		} else {
			$row = mysql_fetch_assoc($sql_result);
			$i = new Instance($row);
		}
		mysql_free_result($sql_result);
		return $i;
	}

	function getInstanceOneByLastRun($order) {
		$q = "
			SELECT , ". $this->getAverageReplyCount() ."
				*
			FROM
				" . $this->cfg->table_prefix . "instances
			ORDER BY
				crawler_last_run
			".$order." LIMIT 1";
		$sql_result = Database::exec($q);
		$row = mysql_fetch_assoc($sql_result);
		$i = new Instance($row);
		mysql_free_result($sql_result);
		return $i;
	}

	function getByUsername($username) {
		$q = "
			SELECT
				* , ". $this->getAverageReplyCount() ."
			FROM
				" . $this->cfg->table_prefix . "instances
			WHERE
				twitter_username = '".$username."'";
		$sql_result = Database::exec($q);

		if (mysql_num_rows  ( $sql_result  ) == 0 ) {
			$i = null;
		} else {
			$row = mysql_fetch_assoc($sql_result);
			$i = new Instance($row);
		}
		mysql_free_result($sql_result);
		return $i;
	}

	function updateLastRun($id) {
		$q = "
			UPDATE
				" . $this->cfg->table_prefix . "instances
			SET
				crawler_last_run = NOW()
			WHERE
				id = ".$id.";";
		$sql_result = Database::exec($q);

	}

	function setPublic($u, $p) {
		$q = "
			UPDATE
				" . $this->cfg->table_prefix . "instances
			SET
				is_public = ".$p."
			WHERE
				twitter_username = '".$u."';";
		$sql_result = Database::exec($q);

	}

	function save($i, $user_xml_total_tweets_by_owner, $logger, $api ) {
		if ($user_xml_total_tweets_by_owner != '')
			$owner_tweets =  "total_tweets_by_owner = ".$user_xml_total_tweets_by_owner.",";
		else
			$owner_tweets = '';

		if ( $i->is_archive_loaded_follows )
			$is_archive_loaded_follows = 1;
		else
			$is_archive_loaded_follows = 0;

		if ( $i->is_archive_loaded_replies )
			$is_archive_loaded_replies = 1;
		else
			$is_archive_loaded_replies = 0;

		$lsi = "";
		if ( $i->last_status_id != "" )
			$lsi = "last_status_id = ". $i->last_status_id .",";

		$q = "
			UPDATE
				" . $this->cfg->table_prefix . "instances
=======
        $sql_result = $this->executeSQL($q);
        if (mysql_num_rows($sql_result) == 0) {
            $i = null;
        } else {
            $row = mysql_fetch_assoc($sql_result);
            $i = new Instance($row);
        }
        mysql_free_result($sql_result);
        return $i;
    }

    
    function getInstanceOneByLastRun($order) {
        $q = "
			SELECT , ".$this->getAverageReplyCount()."
				* 
			FROM 
				%prefix%instances 
			ORDER BY 
				crawler_last_run
			".$order." LIMIT 1";
        $sql_result = $this->executeSQL($q);
        $row = mysql_fetch_assoc($sql_result);
        $i = new Instance($row);
        mysql_free_result($sql_result);
        return $i;
    }
    
    function getByUsername($username) {
        $q = "
			SELECT 
				* , ".$this->getAverageReplyCount()."
			FROM 
				%prefix%instances 
			WHERE 
				twitter_username = '".$username."'";
        $sql_result = $this->executeSQL($q);
        
        if (mysql_num_rows($sql_result) == 0) {
            $i = null;
        } else {
            $row = mysql_fetch_assoc($sql_result);
            $i = new Instance($row);
        }
        mysql_free_result($sql_result);
        return $i;
    }

    
    function updateLastRun($id) {
        $q = "
			UPDATE 
				%prefix%instances
			 SET 
				crawler_last_run = NOW()
			WHERE
				id = ".$id.";";
        $sql_result = $this->executeSQL($q);
        
    }
    
    function setPublic($u, $p) {
        $q = "
			UPDATE 
				%prefix%instances
			 SET 
				is_public = ".$p."
			WHERE
				twitter_username = '".$u."';";
        $sql_result = $this->executeSQL($q);
        
    }

    
    function save($i, $user_xml_total_tweets_by_owner, $logger, $api) {
        if ($user_xml_total_tweets_by_owner != '')
            $owner_tweets = "total_tweets_by_owner = ".$user_xml_total_tweets_by_owner.",";
        else
            $owner_tweets = '';
            
        if ($i->is_archive_loaded_follows)
            $is_archive_loaded_follows = 1;
        else
            $is_archive_loaded_follows = 0;
            
        if ($i->is_archive_loaded_replies)
            $is_archive_loaded_replies = 1;
        else
            $is_archive_loaded_replies = 0;
            
        $lsi = "";
        if ($i->last_status_id != "")
            $lsi = "last_status_id = ".$i->last_status_id.",";
            
        $q = "
			UPDATE 
				%prefix%instances
>>>>>>> 76ef61b3f270b23a3c051a40de2ca94f8be3968e:common/class.Instance.php
			SET
				".$lsi."
				last_page_fetched_followers = ".$i->last_page_fetched_followers.",
				last_page_fetched_replies = ".$i->last_page_fetched_replies.",
				last_page_fetched_tweets = ".$i->last_page_fetched_tweets.",
				crawler_last_run = NOW(),
<<<<<<< HEAD:common/class.Instance.php
				total_tweets_in_system = (select count(*) from " . $this->cfg->table_prefix . "tweets where author_user_id=".$i->twitter_user_id."),
				".$owner_tweets."
				total_replies_in_system = (select count(*) from " . $this->cfg->table_prefix . "tweets where tweet_text like '%@".$i->twitter_username."%'),
				total_follows_in_system = (select count(*) from " . $this->cfg->table_prefix . "follows where user_id=".$i->twitter_user_id." and active=1),
				total_users_in_system = (select count(*) from " . $this->cfg->table_prefix . "users),
				is_archive_loaded_follows = ". $is_archive_loaded_follows .",
				is_archive_loaded_replies = ". $is_archive_loaded_replies .",
				earliest_reply_in_system = (select pub_date from " . $this->cfg->table_prefix . "tweets where tweet_text like '%@".$i->twitter_username."%' order by pub_date asc limit 1),
				earliest_tweet_in_system = (select pub_date from " . $this->cfg->table_prefix . "tweets where author_user_id = ".$i->twitter_user_id." order by pub_date asc limit 1)
			WHERE
				twitter_user_id = ".$i->twitter_user_id.";";
		$foo = Database::exec($q);

		$status_message="Updated ".$i->twitter_username."'s system status.";
		$logger->logStatus($status_message, get_class($this) );
		$status_message = "";

	}

	function isUserConfigured($un) {
		$q = "
			SELECT
				twitter_username
			FROM
				" . $this->cfg->table_prefix . "instances
			WHERE
=======
				total_tweets_in_system = (select count(*) from %prefix%tweets where author_user_id=".$i->twitter_user_id."),
				".$owner_tweets."
				total_replies_in_system = (select count(*) from %prefix%tweets where tweet_text like '%@".$i->twitter_username."%'),
				total_follows_in_system = (select count(*) from %prefix%follows where user_id=".$i->twitter_user_id." and active=1),
				total_users_in_system = (select count(*) from %prefix%users),
				is_archive_loaded_follows = ".$is_archive_loaded_follows.",
				is_archive_loaded_replies = ".$is_archive_loaded_replies.",
				earliest_reply_in_system = (select
					pub_date
				from 
					%prefix%tweets
				where tweet_text like '%@".$i->twitter_username."%'
				order by
					pub_date asc
				limit 1),
				earliest_tweet_in_system = (select
					pub_date
				from 
					%prefix%tweets
				where author_user_id = ".$i->twitter_user_id."
				order by
					pub_date asc
				limit 1)
			WHERE
				twitter_user_id = ".$i->twitter_user_id.";";
        $foo = $this->executeSQL($q);
        
        $status_message = "Updated ".$i->twitter_username."'s system status.";
        $logger->logStatus($status_message, get_class($this));
        $status_message = "";
        
    }
    
    function isUserConfigured($un) {
        $q = "
			SELECT 
				twitter_username 
			FROM 
				%prefix%instances
			WHERE 
>>>>>>> 76ef61b3f270b23a3c051a40de2ca94f8be3968e:common/class.Instance.php
				twitter_username = '".$un."'";
        $sql_result = $this->executeSQL($q);
        if (mysql_num_rows($sql_result) > 0)
            return true;
        else
            return false;
    }
    
    function getAllInstancesStalestFirst() {
        return $this->getAllInstances("ASC");
    }

<<<<<<< HEAD:common/class.Instance.php
	function getAllInstancesStalestFirst() {
		return $this->getAllInstances("ASC");
	}

	function getAllInstances($last_run="DESC") {
		$q = "
			SELECT
				*, ". $this->getAverageReplyCount() ."
			FROM
				" . $this->cfg->table_prefix . "instances
			ORDER BY
				crawler_last_run
			".$last_run."";
		$sql_result = Database::exec($q);
		$instances 		= array();
		while ($row = mysql_fetch_assoc($sql_result)) { $instances[] = new Instance($row); }
		mysql_free_result($sql_result);					# Free up memory
		return $instances;
	}

	function getByOwner($o) {
		if ($o->is_admin) {
			$q = "
				SELECT
					*, ". $this->getAverageReplyCount() ."
				FROM
					" . $this->cfg->table_prefix . "instances i
=======
    
    function getAllInstances($last_run = "DESC") {
        $q = "
			SELECT 
				*, ".$this->getAverageReplyCount()."
			FROM
				%prefix%instances
			ORDER BY
				crawler_last_run
			".$last_run."";
        $sql_result = $this->executeSQL($q);
        $instances = array();
        while ($row = mysql_fetch_assoc($sql_result)) {
            $instances[] = new Instance($row);
        }
        mysql_free_result($sql_result); # Free up memory
        return $instances;
    }
    
    function getByOwner($o) {
        if ($o->is_admin) {
            $q = "
				SELECT 
					*, ".$this->getAverageReplyCount()."
				FROM
					%prefix%instances i
>>>>>>> 76ef61b3f270b23a3c051a40de2ca94f8be3968e:common/class.Instance.php
				ORDER BY
					crawler_last_run
				DESC;";
<<<<<<< HEAD:common/class.Instance.php
		} else {
			$q = "
				SELECT
					*, ". $this->getAverageReplyCount() ."
				FROM
					" . $this->cfg->table_prefix . "owner_instances oi
=======
        } else {
            $q = "
				SELECT 
					*, ".$this->getAverageReplyCount()."
				FROM
					%prefix%owner_instances oi
>>>>>>> 76ef61b3f270b23a3c051a40de2ca94f8be3968e:common/class.Instance.php
				INNER JOIN
					%prefix%instances i
				ON
					i.id = oi.instance_id
				WHERE
					oi.owner_id = ".$o->id."
				ORDER BY
					crawler_last_run
				DESC;";
<<<<<<< HEAD:common/class.Instance.php
		}
		$sql_result = Database::exec($q);
		$instances 		= array();
		while ($row = mysql_fetch_assoc($sql_result)) { $instances[] = new Instance($row); }
		mysql_free_result($sql_result);					# Free up memory
		return $instances;
	}
}
=======
        }
        $sql_result = $this->executeSQL($q);
        $instances = array();
        while ($row = mysql_fetch_assoc($sql_result)) {
            $instances[] = new Instance($row);
        }
        mysql_free_result($sql_result); # Free up memory
        return $instances;
    }

    
}

?>
>>>>>>> 76ef61b3f270b23a3c051a40de2ca94f8be3968e:common/class.Instance.php
